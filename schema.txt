-- Voro 動態網站資料庫結構設計
-- 基於現有 Voro 靜態網站架構，轉換為動態課務系統

-- ==========================================
-- 1. 權限管理模組 (Permission Module)
-- ==========================================

-- 使用者表
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    phone VARCHAR(20) UNIQUE,
    first_name VARCHAR(50) NOT NULL,
    last_name VARCHAR(50) NOT NULL,
    avatar_url VARCHAR(500),
    line_user_id VARCHAR(100) UNIQUE,
    date_of_birth DATE,
    gender ENUM('male', 'female', 'other'),
    address TEXT,
    emergency_contact VARCHAR(100),
    emergency_phone VARCHAR(20),
    status ENUM('active', 'inactive', 'suspended', 'pending_verification') NOT NULL DEFAULT 'pending_verification',
    email_verified_at TIMESTAMP NULL,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    last_login_at TIMESTAMP NULL,
    
    INDEX idx_users_email (email),
    INDEX idx_users_phone (phone),
    INDEX idx_users_status (status),
    INDEX idx_users_created_at (created_at)
);

-- 角色表
CREATE TABLE roles (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(50) UNIQUE NOT NULL,
    display_name VARCHAR(100) NOT NULL,
    description TEXT,
    permissions JSON NOT NULL,
    level INTEGER NOT NULL DEFAULT 1,
    is_system_role BOOLEAN NOT NULL DEFAULT FALSE,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- 使用者角色關聯表
CREATE TABLE user_roles (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL,
    role_id UUID NOT NULL,
    assigned_by UUID NOT NULL,
    assigned_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    expires_at TIMESTAMP NULL,
    is_active BOOLEAN NOT NULL DEFAULT TRUE,
    
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (role_id) REFERENCES roles(id) ON DELETE CASCADE,
    FOREIGN KEY (assigned_by) REFERENCES users(id) ON DELETE RESTRICT,
    UNIQUE KEY unique_user_role (user_id, role_id)
);

-- ==========================================
-- 2. 課程管理模組 (Course Module)
-- ==========================================

-- 課程分類表
CREATE TABLE course_categories (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(100) NOT NULL,
    slug VARCHAR(100) UNIQUE NOT NULL,
    description TEXT,
    parent_id UUID NULL,
    icon_url VARCHAR(500),
    cover_image_url VARCHAR(500),
    sort_order INTEGER NOT NULL DEFAULT 0,
    is_active BOOLEAN NOT NULL DEFAULT TRUE,
    seo_title VARCHAR(200),
    seo_description TEXT,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (parent_id) REFERENCES course_categories(id) ON DELETE SET NULL,
    INDEX idx_categories_parent (parent_id),
    INDEX idx_categories_active (is_active),
    INDEX idx_categories_sort (sort_order)
);

-- 講師資料表 (擴展使用者資料)
CREATE TABLE instructors (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID UNIQUE NOT NULL,
    bio TEXT,
    specialties JSON,
    certifications JSON,
    experience_years INTEGER,
    hourly_rate DECIMAL(10,2),
    availability JSON,
    profile_image_url VARCHAR(500),
    social_links JSON,
    rating DECIMAL(3,2) DEFAULT 0.00,
    total_reviews INTEGER DEFAULT 0,
    total_students INTEGER DEFAULT 0,
    is_featured BOOLEAN NOT NULL DEFAULT FALSE,
    is_active BOOLEAN NOT NULL DEFAULT TRUE,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    INDEX idx_instructors_rating (rating),
    INDEX idx_instructors_featured (is_featured),
    INDEX idx_instructors_active (is_active)
);

-- 課程表
CREATE TABLE courses (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    title VARCHAR(200) NOT NULL,
    slug VARCHAR(200) UNIQUE NOT NULL,
    description TEXT NOT NULL,
    short_description VARCHAR(500),
    instructor_id UUID NOT NULL,
    category_id UUID NOT NULL,
    subcategory_id UUID NULL,
    price DECIMAL(10,2) NOT NULL,
    discount_price DECIMAL(10,2) NULL,
    currency VARCHAR(3) NOT NULL DEFAULT 'TWD',
    duration INTEGER NOT NULL COMMENT '課程總時長(分鐘)',
    session_count INTEGER NOT NULL DEFAULT 1 COMMENT '總堂數',
    max_students INTEGER NOT NULL,
    min_students INTEGER NOT NULL DEFAULT 1,
    difficulty_level ENUM('beginner', 'intermediate', 'advanced') NOT NULL,
    cover_image_url VARCHAR(500),
    gallery_images JSON,
    video_url VARCHAR(500),
    location VARCHAR(200),
    location_details TEXT,
    latitude DECIMAL(10, 8),
    longitude DECIMAL(11, 8),
    equipment_provided TEXT,
    equipment_required TEXT,
    prerequisites TEXT,
    what_to_bring TEXT,
    cancellation_policy TEXT,
    start_date DATE NOT NULL,
    end_date DATE NOT NULL,
    registration_deadline DATE NOT NULL,
    tags JSON,
    features JSON,
    status ENUM('draft', 'published', 'cancelled', 'completed', 'suspended') NOT NULL DEFAULT 'draft',
    featured_until DATE NULL,
    seo_title VARCHAR(200),
    seo_description TEXT,
    view_count INTEGER DEFAULT 0,
    enrollment_count INTEGER DEFAULT 0,
    rating DECIMAL(3,2) DEFAULT 0.00,
    review_count INTEGER DEFAULT 0,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    published_at TIMESTAMP NULL,
    
    FOREIGN KEY (instructor_id) REFERENCES users(id) ON DELETE RESTRICT,
    FOREIGN KEY (category_id) REFERENCES course_categories(id) ON DELETE RESTRICT,
    FOREIGN KEY (subcategory_id) REFERENCES course_categories(id) ON DELETE SET NULL,
    INDEX idx_courses_instructor (instructor_id),
    INDEX idx_courses_category (category_id),
    INDEX idx_courses_status (status),
    INDEX idx_courses_start_date (start_date),
    INDEX idx_courses_price (price),
    INDEX idx_courses_rating (rating),
    INDEX idx_courses_featured (featured_until),
    FULLTEXT idx_courses_search (title, description, tags)
);

-- 課程時段表
CREATE TABLE course_schedules (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    course_id UUID NOT NULL,
    session_number INTEGER NOT NULL,
    session_title VARCHAR(200) NOT NULL,
    session_description TEXT,
    session_date DATE NOT NULL,
    start_time TIME NOT NULL,
    end_time TIME NOT NULL,
    location VARCHAR(200),
    location_details TEXT,
    instructor_notes TEXT,
    max_students INTEGER,
    current_enrollment INTEGER DEFAULT 0,
    is_cancelled BOOLEAN NOT NULL DEFAULT FALSE,
    cancellation_reason TEXT,
    makeup_session_id UUID NULL,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (course_id) REFERENCES courses(id) ON DELETE CASCADE,
    FOREIGN KEY (makeup_session_id) REFERENCES course_schedules(id) ON DELETE SET NULL,
    UNIQUE KEY unique_course_session (course_id, session_number),
    INDEX idx_schedules_course (course_id),
    INDEX idx_schedules_date (session_date),
    INDEX idx_schedules_cancelled (is_cancelled)
);

-- 學員報名表
CREATE TABLE enrollments (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    enrollment_number VARCHAR(50) UNIQUE NOT NULL,
    course_id UUID NOT NULL,
    student_id UUID NOT NULL,
    enrollment_date TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    status ENUM('pending', 'confirmed', 'cancelled', 'completed', 'no_show') NOT NULL DEFAULT 'pending',
    payment_status ENUM('unpaid', 'partial', 'paid', 'refunded', 'cancelled') NOT NULL DEFAULT 'unpaid',
    amount_paid DECIMAL(10,2) DEFAULT 0.00,
    special_requirements TEXT,
    dietary_restrictions TEXT,
    medical_conditions TEXT,
    emergency_contact VARCHAR(100),
    emergency_phone VARCHAR(20),
    source VARCHAR(50) COMMENT '報名來源 (web, line, phone, etc.)',
    referrer_code VARCHAR(50),
    notes TEXT,
    cancelled_at TIMESTAMP NULL,
    cancelled_by UUID NULL,
    cancellation_reason TEXT,
    refund_amount DECIMAL(10,2) DEFAULT 0.00,
    completion_certificate_url VARCHAR(500),
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (course_id) REFERENCES courses(id) ON DELETE RESTRICT,
    FOREIGN KEY (student_id) REFERENCES users(id) ON DELETE RESTRICT,
    FOREIGN KEY (cancelled_by) REFERENCES users(id) ON DELETE SET NULL,
    UNIQUE KEY unique_course_student (course_id, student_id),
    INDEX idx_enrollments_course (course_id),
    INDEX idx_enrollments_student (student_id),
    INDEX idx_enrollments_status (status),
    INDEX idx_enrollments_payment_status (payment_status),
    INDEX idx_enrollments_date (enrollment_date)
);

-- 出席記錄表
CREATE TABLE attendances (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    enrollment_id UUID NOT NULL,
    schedule_id UUID NOT NULL,
    status ENUM('present', 'absent', 'late', 'excused', 'partial') NOT NULL,
    check_in_time TIMESTAMP NULL,
    check_out_time TIMESTAMP NULL,
    notes TEXT,
    instructor_notes TEXT,
    makeup_required BOOLEAN DEFAULT FALSE,
    makeup_completed BOOLEAN DEFAULT FALSE,
    recorded_by UUID NOT NULL,
    recorded_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (enrollment_id) REFERENCES enrollments(id) ON DELETE CASCADE,
    FOREIGN KEY (schedule_id) REFERENCES course_schedules(id) ON DELETE CASCADE,
    FOREIGN KEY (recorded_by) REFERENCES users(id) ON DELETE RESTRICT,
    UNIQUE KEY unique_enrollment_schedule (enrollment_id, schedule_id),
    INDEX idx_attendances_enrollment (enrollment_id),
    INDEX idx_attendances_schedule (schedule_id),
    INDEX idx_attendances_status (status)
);

-- 課程評價表
CREATE TABLE course_reviews (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    course_id UUID NOT NULL,
    student_id UUID NOT NULL,
    enrollment_id UUID NOT NULL,
    rating INTEGER NOT NULL CHECK (rating >= 1 AND rating <= 5),
    title VARCHAR(200),
    content TEXT,
    instructor_rating INTEGER CHECK (instructor_rating >= 1 AND instructor_rating <= 5),
    facility_rating INTEGER CHECK (facility_rating >= 1 AND facility_rating <= 5),
    value_rating INTEGER CHECK (value_rating >= 1 AND value_rating <= 5),
    is_anonymous BOOLEAN DEFAULT FALSE,
    is_verified BOOLEAN DEFAULT FALSE,
    is_featured BOOLEAN DEFAULT FALSE,
    helpful_count INTEGER DEFAULT 0,
    status ENUM('pending', 'approved', 'rejected', 'hidden') DEFAULT 'pending',
    admin_notes TEXT,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (course_id) REFERENCES courses(id) ON DELETE CASCADE,
    FOREIGN KEY (student_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (enrollment_id) REFERENCES enrollments(id) ON DELETE CASCADE,
    UNIQUE KEY unique_course_student_review (course_id, student_id),
    INDEX idx_reviews_course (course_id),
    INDEX idx_reviews_student (student_id),
    INDEX idx_reviews_rating (rating),
    INDEX idx_reviews_status (status)
);

-- ==========================================
-- 3. 帳務管理模組 (Billing Module)
-- ==========================================

-- 訂單表
CREATE TABLE orders (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    order_number VARCHAR(50) UNIQUE NOT NULL,
    user_id UUID NOT NULL,
    order_type ENUM('course_enrollment', 'merchandise', 'service') DEFAULT 'course_enrollment',
    subtotal DECIMAL(10,2) NOT NULL,
    discount_amount DECIMAL(10,2) NOT NULL DEFAULT 0.00,
    tax_amount DECIMAL(10,2) NOT NULL DEFAULT 0.00,
    shipping_amount DECIMAL(10,2) NOT NULL DEFAULT 0.00,
    total_amount DECIMAL(10,2) NOT NULL,
    currency VARCHAR(3) NOT NULL DEFAULT 'TWD',
    status ENUM('pending', 'confirmed', 'paid', 'cancelled', 'refunded', 'expired') NOT NULL DEFAULT 'pending',
    payment_method ENUM('credit_card', 'bank_transfer', 'cash', 'line_pay', 'apple_pay', 'google_pay') NULL,
    payment_deadline TIMESTAMP NOT NULL,
    billing_address JSON,
    shipping_address JSON,
    customer_notes TEXT,
    admin_notes TEXT,
    invoice_number VARCHAR(50) UNIQUE,
    invoice_date DATE,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    confirmed_at TIMESTAMP NULL,
    paid_at TIMESTAMP NULL,
    cancelled_at TIMESTAMP NULL,
    
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE RESTRICT,
    INDEX idx_orders_user (user_id),
    INDEX idx_orders_status (status),
    INDEX idx_orders_created_at (created_at),
    INDEX idx_orders_number (order_number)
);

-- 訂單項目表
CREATE TABLE order_items (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    order_id UUID NOT NULL,
    item_type ENUM('course', 'merchandise', 'service') NOT NULL,
    item_id UUID NOT NULL COMMENT '課程ID或商品ID',
    item_name VARCHAR(200) NOT NULL,
    item_description TEXT,
    quantity INTEGER NOT NULL DEFAULT 1,
    unit_price DECIMAL(10,2) NOT NULL,
    discount_amount DECIMAL(10,2) NOT NULL DEFAULT 0.00,
    subtotal DECIMAL(10,2) NOT NULL,
    item_data JSON COMMENT '項目相關數據',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (order_id) REFERENCES orders(id) ON DELETE CASCADE,
    INDEX idx_order_items_order (order_id),
    INDEX idx_order_items_type (item_type, item_id)
);

-- 付款記錄表
CREATE TABLE payments (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    order_id UUID NOT NULL,
    payment_number VARCHAR(50) UNIQUE NOT NULL,
    payment_method ENUM('credit_card', 'bank_transfer', 'cash', 'line_pay', 'apple_pay', 'google_pay') NOT NULL,
    amount DECIMAL(10,2) NOT NULL,
    currency VARCHAR(3) NOT NULL DEFAULT 'TWD',
    transaction_id VARCHAR(100) UNIQUE,
    gateway_name VARCHAR(50),
    gateway_transaction_id VARCHAR(100),
    gateway_response JSON,
    status ENUM('pending', 'processing', 'success', 'failed', 'cancelled', 'refunded') NOT NULL DEFAULT 'pending',
    failure_reason TEXT,
    processed_at TIMESTAMP NULL,
    reconciled_at TIMESTAMP NULL,
    notes TEXT,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (order_id) REFERENCES orders(id) ON DELETE RESTRICT,
    INDEX idx_payments_order (order_id),
    INDEX idx_payments_status (status),
    INDEX idx_payments_method (payment_method),
    INDEX idx_payments_created_at (created_at)
);

-- 優惠券表
CREATE TABLE coupons (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    code VARCHAR(50) UNIQUE NOT NULL,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    type ENUM('percentage', 'fixed_amount', 'free_shipping') NOT NULL,
    value DECIMAL(10,2) NOT NULL,
    min_amount DECIMAL(10,2) NOT NULL DEFAULT 0.00,
    max_discount DECIMAL(10,2) NULL,
    currency VARCHAR(3) NOT NULL DEFAULT 'TWD',
    valid_from DATE NOT NULL,
    valid_until DATE NOT NULL,
    usage_limit INTEGER NULL,
    usage_limit_per_user INTEGER NULL,
    used_count INTEGER NOT NULL DEFAULT 0,
    applicable_categories JSON,
    applicable_courses JSON,
    applicable_users JSON,
    is_active BOOLEAN NOT NULL DEFAULT TRUE,
    created_by UUID NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (created_by) REFERENCES users(id) ON DELETE RESTRICT,
    INDEX idx_coupons_code (code),
    INDEX idx_coupons_valid_period (valid_from, valid_until),
    INDEX idx_coupons_active (is_active)
);

-- 優惠券使用記錄表
CREATE TABLE coupon_usages (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    coupon_id UUID NOT NULL,
    user_id UUID NOT NULL,
    order_id UUID NOT NULL,
    discount_amount DECIMAL(10,2) NOT NULL,
    used_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (coupon_id) REFERENCES coupons(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (order_id) REFERENCES orders(id) ON DELETE CASCADE,
    INDEX idx_coupon_usages_coupon (coupon_id),
    INDEX idx_coupon_usages_user (user_id),
    INDEX idx_coupon_usages_order (order_id)
);

-- 退款記錄表
CREATE TABLE refunds (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    refund_number VARCHAR(50) UNIQUE NOT NULL,
    order_id UUID NOT NULL,
    payment_id UUID NOT NULL,
    amount DECIMAL(10,2) NOT NULL,
    currency VARCHAR(3) NOT NULL DEFAULT 'TWD',
    reason ENUM('customer_request', 'course_cancelled', 'system_error', 'duplicate_payment', 'other') NOT NULL,
    reason_details TEXT,
    status ENUM('pending', 'approved', 'rejected', 'processing', 'completed', 'failed') NOT NULL DEFAULT 'pending',
    gateway_refund_id VARCHAR(100),
    gateway_response JSON,
    requested_by UUID NOT NULL,
    approved_by UUID NULL,
    processed_by UUID NULL,
    requested_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    approved_at TIMESTAMP NULL,
    processed_at TIMESTAMP NULL,
    completed_at TIMESTAMP NULL,
    admin_notes TEXT,
    
    FOREIGN KEY (order_id) REFERENCES orders(id) ON DELETE RESTRICT,
    FOREIGN KEY (payment_id) REFERENCES payments(id) ON DELETE RESTRICT,
    FOREIGN KEY (requested_by) REFERENCES users(id) ON DELETE RESTRICT,
    FOREIGN KEY (approved_by) REFERENCES users(id) ON DELETE SET NULL,
    FOREIGN KEY (processed_by) REFERENCES users(id) ON DELETE SET NULL,
    INDEX idx_refunds_order (order_id),
    INDEX idx_refunds_payment (payment_id),
    INDEX idx_refunds_status (status),
    INDEX idx_refunds_requested_at (requested_at)
);

-- ==========================================
-- 4. 內容管理模組 (Content Module)
-- ==========================================

-- 網頁內容表
CREATE TABLE page_contents (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    page_key VARCHAR(100) UNIQUE NOT NULL COMMENT '頁面識別鍵 (home, about, contact, etc.)',
    title VARCHAR(200) NOT NULL,
    slug VARCHAR(200) UNIQUE NOT NULL,
    content LONGTEXT,
    meta_title VARCHAR(200),
    meta_description TEXT,
    meta_keywords TEXT,
    featured_image_url VARCHAR(500),
    gallery_images JSON,
    layout_config JSON,
    is_published BOOLEAN NOT NULL DEFAULT FALSE,
    sort_order INTEGER DEFAULT 0,
    created_by UUID NOT NULL,
    updated_by UUID NULL,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    published_at TIMESTAMP NULL,
    
    FOREIGN KEY (created_by) REFERENCES users(id) ON DELETE RESTRICT,
    FOREIGN KEY (updated_by) REFERENCES users(id) ON DELETE SET NULL,
    INDEX idx_page_contents_slug (slug),
    INDEX idx_page_contents_published (is_published)
);

-- 新聞動態表
CREATE TABLE news_articles (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    title VARCHAR(200) NOT NULL,
    slug VARCHAR(200) UNIQUE NOT NULL,
    summary VARCHAR(500),
    content LONGTEXT NOT NULL,
    featured_image_url VARCHAR(500),
    gallery_images JSON,
    author_id UUID NOT NULL,
    category VARCHAR(100),
    tags JSON,
    view_count INTEGER DEFAULT 0,
    is_featured BOOLEAN DEFAULT FALSE,
    is_published BOOLEAN NOT NULL DEFAULT FALSE,
    meta_title VARCHAR(200),
    meta_description TEXT,
    published_at TIMESTAMP NULL,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (author_id) REFERENCES users(id) ON DELETE RESTRICT,
    INDEX idx_news_author (author_id),
    INDEX idx_news_category (category),
    INDEX idx_news_published (is_published),
    INDEX idx_news_featured (is_featured),
    INDEX idx_news_published_at (published_at),
    FULLTEXT idx_news_search (title, summary, content)
);

-- 服務項目表
CREATE TABLE services (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    title VARCHAR(200) NOT NULL,
    slug VARCHAR(200) UNIQUE NOT NULL,
    description TEXT NOT NULL,
    short_description VARCHAR(500),
    icon_url VARCHAR(500),
    image_url VARCHAR(500),
    gallery_images JSON,
    price_info TEXT,
    features JSON,
    category VARCHAR(100),
    sort_order INTEGER DEFAULT 0,
    is_active BOOLEAN NOT NULL DEFAULT TRUE,
    is_featured BOOLEAN DEFAULT FALSE,
    meta_title VARCHAR(200),
    meta_description TEXT,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_services_category (category),
    INDEX idx_services_active (is_active),
    INDEX idx_services_featured (is_featured),
    INDEX idx_services_sort (sort_order)
);

-- ==========================================
-- 5. 系統管理模組 (System Module)
-- ==========================================

-- 系統設定表
CREATE TABLE system_settings (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    setting_key VARCHAR(100) UNIQUE NOT NULL,
    setting_value TEXT NOT NULL,
    value_type ENUM('string', 'number', 'boolean', 'json', 'file') NOT NULL DEFAULT 'string',
    category VARCHAR(50) NOT NULL,
    description TEXT,
    is_public BOOLEAN NOT NULL DEFAULT FALSE,
    validation_rules JSON,
    updated_by UUID NOT NULL,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (updated_by) REFERENCES users(id) ON DELETE RESTRICT,
    INDEX idx_settings_category (category),
    INDEX idx_settings_public (is_public)
);

-- 系統操作日誌表
CREATE TABLE audit_logs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NULL,
    action VARCHAR(100) NOT NULL,
    resource_type VARCHAR(50) NOT NULL,
    resource_id UUID NULL,
    old_values JSON NULL,
    new_values JSON NULL,
    ip_address VARCHAR(45),
    user_agent TEXT,
    session_id VARCHAR(255),
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE SET NULL,
    INDEX idx_audit_logs_user (user_id),
    INDEX idx_audit_logs_resource (resource_type, resource_id),
    INDEX idx_audit_logs_action (action),
    INDEX idx_audit_logs_created_at (created_at)
);

-- 系統通知表
CREATE TABLE system_notifications (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NULL COMMENT 'NULL表示系統全域通知',
    title VARCHAR(200) NOT NULL,
    message TEXT NOT NULL,
    type ENUM('info', 'success', 'warning', 'error') DEFAULT 'info',
    category VARCHAR(50),
    action_url VARCHAR(500),
    action_text VARCHAR(100),
    is_read BOOLEAN DEFAULT FALSE,
    is_global BOOLEAN DEFAULT FALSE,
    expires_at TIMESTAMP NULL,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    read_at TIMESTAMP NULL,
    
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    INDEX idx_notifications_user (user_id),
    INDEX idx_notifications_type (type),
    INDEX idx_notifications_read (is_read),
    INDEX idx_notifications_global (is_global),
    INDEX idx_notifications_created_at (created_at)
);

-- ==========================================
-- 6. LINE OA 整合模組
-- ==========================================

-- LINE 使用者關聯表
CREATE TABLE line_users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    line_user_id VARCHAR(100) UNIQUE NOT NULL,
    user_id UUID NULL,
    display_name VARCHAR(100),
    picture_url VARCHAR(500),
    status_message TEXT,
    language VARCHAR(10),
    is_blocked BOOLEAN DEFAULT FALSE,
    is_bot_blocked BOOLEAN DEFAULT FALSE,
    first_interaction_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    last_interaction_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    interaction_count INTEGER DEFAULT 0,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE SET NULL,
    INDEX idx_line_users_user (user_id),
    INDEX idx_line_users_blocked (is_blocked),
    INDEX idx_line_users_last_interaction (last_interaction_at)
);

-- LINE 訊息記錄表
CREATE TABLE line_messages (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    line_user_id VARCHAR(100) NOT NULL,
    message_type ENUM('text', 'image', 'video', 'audio', 'file', 'location', 'sticker', 'template') NOT NULL,
    direction ENUM('incoming', 'outgoing') NOT NULL,
    content TEXT,
    reply_token VARCHAR(255),
    message_id VARCHAR(255) UNIQUE,
    quick_reply_used VARCHAR(100),
    postback_data TEXT,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (line_user_id) REFERENCES line_users(line_user_id) ON DELETE CASCADE,
    INDEX idx_line_messages_user (line_user_id),
    INDEX idx_line_messages_direction (direction),
    INDEX idx_line_messages_type (message_type),
    INDEX idx_line_messages_created_at (created_at)
);

-- ==========================================
-- 7. 檔案管理模組
-- ==========================================

-- 檔案上傳記錄表
CREATE TABLE file_uploads (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    original_name VARCHAR(255) NOT NULL,
    stored_name VARCHAR(255) NOT NULL,
    file_path VARCHAR(500) NOT NULL,
    file_url VARCHAR(500) NOT NULL,
    file_size BIGINT NOT NULL,
    mime_type VARCHAR(100) NOT NULL,
    file_extension VARCHAR(10),
    uploaded_by UUID NOT NULL,
    usage_type ENUM('avatar', 'course_cover', 'course_gallery', 'news_image', 'service_image', 'document', 'other') NOT NULL,
    related_id UUID NULL COMMENT '關聯的資源ID',
    is_temporary BOOLEAN DEFAULT TRUE,
    is_public BOOLEAN DEFAULT FALSE,
    metadata JSON,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (uploaded_by) REFERENCES users(id) ON DELETE RESTRICT,
    INDEX idx_file_uploads_uploader (uploaded_by),
    INDEX idx_file_uploads_usage (usage_type, related_id),
    INDEX idx_file_uploads_temporary (is_temporary),
    INDEX idx_file_uploads_created_at (created_at)
);

-- ==========================================
-- 8. 初始資料插入
-- ==========================================

-- 插入預設角色
INSERT INTO roles (name, display_name, description, permissions, level, is_system_role) VALUES
('super_admin', '超級管理員', '系統最高權限管理員', '["*"]', 100, TRUE),
('admin', '管理員', '系統管理員', '["admin.*", "course.*", "user.*", "order.*"]', 90, TRUE),
('instructor', '講師', '課程講師', '["course.view", "course.create", "course.update_own", "student.view"]', 50, TRUE),
('student', '學員', '一般學員', '["course.view", "enrollment.create", "profile.update_own"]', 10, TRUE),
('guest', '訪客', '未註冊使用者', '["course.view_public"]', 1, TRUE);

-- 插入預設課程分類
INSERT INTO course_categories (name, slug, description, sort_order) VALUES
('游泳', 'swimming', '游泳相關課程與訓練', 1),
('單車', 'cycling', '單車騎乘技巧與訓練', 2),
('跑步', 'running', '跑步技巧與耐力訓練', 3),
('鐵人三項', 'triathlon', '綜合鐵人三項訓練', 4),
('體能訓練', 'fitness', '體能與肌力訓練', 5);

-- 插入系統設定
INSERT INTO system_settings (setting_key, setting_value, value_type, category, description, is_public) VALUES
('site_name', 'Voro 運動體驗搜尋', 'string', 'general', '網站名稱', TRUE),
('site_description', 'Voro 提供鐵人三項訓練：游泳、單車、跑步課程與活動搜尋', 'string', 'general', '網站描述', TRUE),
('contact_email', 'info@voro.com', 'string', 'contact', '聯絡信箱', TRUE),
('contact_phone', '+886-2-1234-5678', 'string', 'contact', '聯絡電話', TRUE),
('default_currency', 'TWD', 'string', 'payment', '預設幣別', FALSE),
('payment_deadline_hours', '72', 'number', 'payment', '付款期限(小時)', FALSE),
('max_file_size_mb', '10', 'number', 'upload', '檔案上傳大小限制(MB)', FALSE);